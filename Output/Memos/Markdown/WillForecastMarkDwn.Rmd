---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: false
    latex_engine: pdflatex
    template: "svm-latex-memo.tex"
fontfamily: times
fontsize: 12pt
geometry: margin=0.8in
header-includes:
   - \linespread{0.90}

from: Adam Storch
to: Files
subject: "`r paste0(as.numeric(format(Sys.Date(), '%Y'))-1, ' Willamette River spring Chinook Run and ',as.numeric(format(Sys.Date(), '%Y')), ' forecast')`"
date: "`r format(as.Date('2012-08-13'), '%d %B %Y')`"
memorandum: true
graphics: true
width: 0.2
logoposition: left
logo: "odfwLogo.v.2.png"
---
```{r echo=FALSE}
harv_rt_form = function(x) ifelse(is.na(x),"", sprintf("%.1f%%", x*100))
harv_rt_formSm = function(x) ifelse(is.na(x),"", sprintf("%.2f%%", x*100))
int_form = function(x) ifelse(is.na(x),"", formatC(x,digits = 0, format = "f", big.mark = ","))
int_deci_form = function(x) ifelse(is.na(x),"", formatC(x,digits = 1, format = "f", big.mark = ","))
year_form = function(x) ifelse(is.na(x),"", formatC(x,digits = 0, format = "f"))
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(flextable)
library(ggplot2)
library(magrittr)
library(openxlsx)
library(officer)
library(webshot)
library(officedown)
library(data.table)
library(berryFunctions)
library(scales)

set_flextable_defaults(fonts_ignore=TRUE)
```

```{r echo=FALSE}
### define current run year (value has to be entered manually)
curr_year <- 2022

### load data files
#### define file path (make sure: Tools->Global Options...->R Markdown->
#### Evaluate chunks in directory = "Project")
inPath <- 'Input\\~Input Data\\Input Tables\\'
predPath <- 'Output\\Predictions\\'
rrPath <- "Input\\~Input Data\\Run Reconstruction\\"

#### run reconstruction tables
willClackRR.dat <- readRDS(
  paste(
    rrPath,
    curr_year,
    'willClackRRData.rds',
    sep = ""
  )
)

#### model input data
load(
  file = paste(
    inPath,
    curr_year,
    "willClackInpData.rda",
    sep=""
  )
)

#### prediction tables
##### new Willamette (curr_year+1) predictions
curr.will.predns <- readRDS(
  paste(
    predPath,
    curr_year+1,
    'willComb.pred.out.rds',
    sep = ""
  )
)

##### prior years' Willamette (curr_year) predictions
prior.will.predns <- readRDS(
  paste(
    predPath,
    curr_year,
    'willComb.pred.out.rds',
    sep = ""
  )
)

##### new clackamas (curr_year+1) predictions
curr.clack.predns <- readRDS(
  paste(
    predPath,
    curr_year+1,
    'clack.pred.out.rds',
    sep = ""
  )
)

##### prior years' Clackamas (curr_year) predictions
prior.clack.predns <- readRDS(
  paste(
    predPath,
    curr_year,
    'clack.pred.out.rds',
    sep = ""
  )
)
     
```
  
## Summary of `r as.numeric(curr_year)` Willamette River spring Chinook return

### Subsection Test

The total Willamette River spring Chinook return to the Columbia River mouth during `r as.numeric(curr_year)` is estimated to be `r format(willChsRet.dat[nrow(willChsRet.dat)-1,3] + willChsRet.dat[nrow(willChsRet.dat)-2,4] + willChsRet.dat[nrow(willChsRet.dat)-3,5] + willChsRet.dat[nrow(willChsRet.dat)-4,6], big.mark = ",")` fish (Table 1).  An estimated `r format(as.numeric(subset(willClackRR.dat, catch=="Run Entering Columbia", select = c(wild))), big.mark = ",")` of these fish were unmarked (~`r percent(willChsHWprop.dat[nrow(willChsHWprop.dat),4])`).  The `r as.numeric(curr_year)` total reconstructed return was approximately `r percent(as.numeric(willChsRet.dat[nrow(willChsRet.dat)-1,3] + willChsRet.dat[nrow(willChsRet.dat)-2,4] + willChsRet.dat[nrow(willChsRet.dat)-3,5] + willChsRet.dat[nrow(willChsRet.dat)-4,6])/as.numeric(prior.will.predns[6,2]))` of forecast.  The Clackamas River component was approximately `r percent(as.numeric(clackChsRet.dat[nrow(clackChsRet.dat),6])/as.numeric(prior.clack.predns[,2]))` of forecast, with `r format(clackChsRet.dat[nrow(clackChsRet.dat),6], big.mark = ",")` spring Chinook returning to the Clackamas River compared to `r format(as.numeric(prior.clack.predns[,2]), big.mark = ",")` (95% credible interval: `r format(as.numeric(prior.clack.predns[,3]), big.mark = ",")`–`r format(as.numeric(prior.clack.predns[,4]), big.mark = ",")`) fish expected.

The total return of adipose-fin-marked hatchery fish to the Columbia River mouth in `r as.numeric(curr_year)` is estimated to be `r format(as.numeric(subset(willClackRR.dat, catch=="Run Entering Columbia", select = c(hatchery))), big.mark = ",")`, compared to `r format(as.numeric(prior.will.predns[12,2]), big.mark = ",")` (95% credible interval: `r format(as.numeric(prior.will.predns[12,3]), big.mark = ",")`–`r format(as.numeric(prior.will.predns[12,4]), big.mark = ",")`) fish expected.  Counts at the Willamette Falls fishway indicate that `r format(as.numeric(subset(willClackRR.dat, catch=="Willamette Falls Count", select = c(hatchery))), big.mark = ",")` fin-marked hatchery fish and `r format(as.numeric(subset(willClackRR.dat, catch=="Willamette Falls Count", select = c(wild))), big.mark = ",")` unmarked fish passed the fish ladder.  The full reconstruction of the 2022 return is shown in Table 2.

```{r Table-mgmt rep T1 data, echo=FALSE}
T1 <- data.frame(rowLabel = c(paste0(curr_year, " Forecast"),
                              "95% CrI",
                              paste0(curr_year, " Reconstructed Return")),
                 
                 age_3 = c(
                   format(
                     as.numeric(
                       subset(
                         prior.will.predns,
                         model=="Willamette Age-3",
                         select = c(mean.pred.will)
                         )
                       ),
                     big.mark = ","
                     ),
                            paste0(
                              ifelse(
                                as.numeric(
                                  subset(
                                    prior.will.predns,
                                    model=="Willamette Age-3",
                                    select = c(lwrHDI.will)
                                    )
                                  )<0,0,
                                format(
                                  as.numeric(
                                    subset(
                                      prior.will.predns,
                                      model=="Willamette Age-3",
                                      select = c(lwrHDI.will)
                                      )
                                    ),
                                  big.mark = ","
                                  )
                                ),
                              "\u2013",
                              ifelse(
                                as.numeric(
                                  subset(
                                    prior.will.predns, 
                                    model=="Willamette Age-3", 
                                    select = c(uprHDI.will)
                                    )
                                  )<0,
                                0,
                                format(
                                  as.numeric(
                                    subset(
                                      prior.will.predns, 
                                      model=="Willamette Age-3", 
                                      select = c(uprHDI.will)
                                      )
                                    ), 
                                  big.mark = ","
                                  )
                                ),
                              sep=""
                              ),
                   format(
                     as.numeric(
                       subset(
                         willClackRR.dat, 
                         catch=="Run Entering Columbia", 
                         select = c(age_3)
                         )
                       ), 
                     big.mark = ","
                     )
                   ),
                 
                 age_4 = c(
                   format(
                     as.numeric(
                       subset(
                         prior.will.predns, 
                         model=="Willamette Age-4", 
                         select = c(mean.pred.will)
                         )
                       ), 
                     big.mark = ","
                     ),
                   paste0(
                     ifelse(
                       as.numeric(
                         subset(
                           prior.will.predns, 
                           model=="Willamette Age-4", 
                           select = c(lwrHDI.will)
                           )
                         )<0,
                       0,
                       format(
                         as.numeric(
                           subset(
                             prior.will.predns, 
                             model=="Willamette Age-4", 
                             select = c(lwrHDI.will)
                             )
                           ), 
                         big.mark = ","
                         )
                       ),
                     "\u2013",
                     ifelse(
                       as.numeric(
                         subset(
                           prior.will.predns, 
                           model=="Willamette Age-4", 
                           select = c(uprHDI.will)
                           )
                         )<0,
                       0,
                       format(
                         as.numeric(
                           subset(prior.will.predns, 
                                  model=="Willamette Age-4", 
                                  select = c(uprHDI.will)
                                  )
                           ), 
                         big.mark = ","
                         )
                       ),
                     sep=""
                     ),
                   format(
                     as.numeric(
                       subset(
                         willClackRR.dat, 
                         catch=="Run Entering Columbia", 
                         select = c(age_4)
                         )
                       ), 
                     big.mark = ","
                     )
                   ),
                 
                 age_5 = c(
                   format(
                     as.numeric(
                       subset(
                         prior.will.predns, 
                         model=="Willamette Age-5", 
                         select = c(mean.pred.will)
                         )
                       ), 
                     big.mark = ","
                     ),
                   paste0(
                     ifelse(
                       as.numeric(
                         subset(
                           prior.will.predns, 
                           model=="Willamette Age-5", 
                           select = c(lwrHDI.will)
                           )
                         )<0,
                       0,
                       format(
                         as.numeric(
                           subset(
                             prior.will.predns, 
                             model=="Willamette Age-5", 
                             select = c(lwrHDI.will)
                             )
                           ), 
                         big.mark = ","
                         )
                       ),
                     "\u2013",
                     ifelse(
                       as.numeric(
                         subset(
                           prior.will.predns, 
                           model=="Willamette Age-5", 
                           select = c(uprHDI.will)
                           )
                         )<0,
                       0,
                       format(
                         as.numeric(
                           subset(
                             prior.will.predns, 
                             model=="Willamette Age-5", 
                             select = c(uprHDI.will)
                             )
                           ), 
                         big.mark = ","
                         )
                       ),
                     sep=""
                     ),
                   format(
                     as.numeric(
                       subset(
                         willClackRR.dat, 
                         catch=="Run Entering Columbia", 
                         select = c(age_5)
                         )
                       ), 
                     big.mark = ","
                     )
                   ),
                 
                 age_6 = c(
                   format(
                     as.numeric(
                       subset(
                         prior.will.predns, 
                         model=="Willamette Age-6", 
                         select = c(mean.pred.will)
                         )
                       ), 
                     big.mark = ","
                     ),
                   paste0(
                     ifelse(
                       as.numeric(
                         subset(
                           prior.will.predns, 
                           model=="Willamette Age-6", 
                           select = c(lwrHDI.will)
                           )
                         )<0,
                       0,
                       format(
                         as.numeric(
                           subset(
                             prior.will.predns, 
                             model=="Willamette Age-6", 
                             select = c(lwrHDI.will)
                             )
                           ), 
                         big.mark = ","
                         )
                       ),
                     "\u2013",
                     ifelse(
                       as.numeric(
                         subset(
                           prior.will.predns, 
                           model=="Willamette Age-6", 
                           select = c(uprHDI.will)
                           )
                         )<0,
                       0,
                       format(
                         as.numeric(
                           subset(
                             prior.will.predns, 
                             model=="Willamette Age-6", 
                             select = c(uprHDI.will)
                             )
                           ), 
                         big.mark = ","
                         )
                       ),
                     sep=""
                     ),
                   format(
                     as.numeric(
                       subset(
                         willClackRR.dat, 
                         catch=="Run Entering Columbia", 
                         select = c(age_6)
                         )
                       ), 
                     big.mark = ","
                     )
                   ),
                 
                 
                 
                 adults = c(
                   format(
                     as.numeric(
                       subset(
                         prior.will.predns, 
                         model=="Willamette Adults", 
                         select = c(mean.pred.will)
                         )
                       ), 
                     big.mark = ","
                     ),
                   paste0(
                     ifelse(
                       as.numeric(
                         subset(prior.will.predns, 
                                model=="Willamette Adults", 
                                select = c(lwrHDI.will)
                                )
                         )<0,
                       0,
                       format(
                         as.numeric(
                           subset(
                             prior.will.predns, 
                             model=="Willamette Adults", 
                             select = c(lwrHDI.will)
                             )
                           ), 
                         big.mark = ","
                         )
                       ),
                     "\u2013",
                     ifelse(
                       as.numeric(
                         subset(
                           prior.will.predns, 
                           model=="Willamette Adults", 
                           select = c(uprHDI.will)
                           )
                         )<0,
                       0,
                       format(
                         as.numeric(
                           subset(
                             prior.will.predns, 
                             model=="Willamette Adults", 
                             select = c(uprHDI.will)
                             )
                           ), 
                         big.mark = ","
                         )
                       ),
                     sep=""
                     ),
                   format(
                     as.numeric(
                       subset(
                         willClackRR.dat, 
                         catch=="Run Entering Columbia", 
                         select = c(adults)
                         )
                       ), 
                     big.mark = ","
                     )
                   ),
                 
                 total = c(
                   format(
                     as.numeric(
                       subset(
                         prior.will.predns, 
                         model=="Willamette Total", 
                         select = c(mean.pred.will)
                         )
                       ), 
                     big.mark = ","
                     ),
                   paste0(
                     ifelse(
                       as.numeric(
                         subset(
                           prior.will.predns, 
                           model=="Willamette Total", 
                           select = c(lwrHDI.will)
                           )
                         )<0,
                       0,
                       format(
                         as.numeric(
                           subset(
                             prior.will.predns, 
                             model=="Willamette Total", 
                             select = c(lwrHDI.will)
                             )
                           ), 
                         big.mark = ","
                         )
                       ),
                     "\u2013",
                     ifelse(
                       as.numeric(
                         subset(
                           prior.will.predns, 
                           model=="Willamette Total", 
                           select = c(uprHDI.will)
                           )
                         )<0,
                       0,
                       format(
                         as.numeric(
                           subset(
                             prior.will.predns, 
                             model=="Willamette Total", 
                             select = c(uprHDI.will)
                             )
                           ), 
                         big.mark = ","
                         )
                       ),
                     sep=""
                     ),
                   format(
                     as.numeric(
                       subset(
                         willClackRR.dat, 
                         catch=="Run Entering Columbia", 
                         select = c(total)
                         )
                       ), 
                     big.mark = ","
                     )
                   )
                 )
```
Table 1. `r paste0(curr_year," forecasted and reconstructed return of Willamette River spring Chinook to Columbia River mouth",sep="")`.
```{r Table 1, echo=FALSE, ft.arraystretch = 1.05}
flextable(T1) %>% 
  align(align = "center",
        part = "all") %>%
  valign(i = 1,
         valign = "bottom",
         part = "header") %>%
  padding(padding = 0, part = "all") %>% 
  set_header_labels(rowLabel = "",
                    age_3 = "Age 3",
                    age_4 = "Age 4",
                    age_5 = "Age 5",
                    age_6 = "Age 6",
                    adults = "Totaladults",  
                    total = "Totaljacks+adults") %>%
  fontsize(size = 9,
           part = "all") %>%
  font(fontname = "Times New Roman",
       part = "all") %>%
  border_remove() %>%
  hline(i=1,
        part="header",
        border = fp_border(color="black",
                           width = 0.5)) %>%
  hline(i=2,
        part="body",
        border = fp_border(color="black",
                           width = 0.5)) %>%
  hline_top(part="header",
            border = fp_border(color="black",
                               width = 1.0)) %>%
  hline_bottom(part="body",
               border = fp_border(color="black",
                                  width = 1.0)) %>%
  width(j = 1, 1.4) %>% 
  width(j = 2:7, 0.9)
  # bold(i = ~ tot_act_treat_harv_rate > tot_all_treat_harvest_rate,
  #      j = ~ tot_act_treat_harv_rate + tot_treat_impacts) %>%
  # add_footer_lines("Note: bold values indicate overage.") %>%
  # fontsize(size = 12, part = "footer") %>%
  # font(fontname = "Times New Roman",
  #      # part = "footer") %>%
  # # padding(padding = 0, part = "footer")
  # set_caption(
  #   as_paragraph(
  #     as_chunk(paste0(curr_year," forecasted and reconstructed return of Willamette River spring Chinook to Columbia River mouth",sep=""),
  #              props = fp_text_default(font.family = "Times New Roman",
  #                                      font.size = 12))),
  #   align_with_table = TRUE,
  #   word_stylename = "Table Caption")
  #   # fp_p = table.caption.format)
  #   # autonum = autonumTab)
```
